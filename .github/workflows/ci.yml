name: CI
on: [push, pull_request, workflow_dispatch]

# Prevent intermediate images from being used by another run.
# Concurrency group is unique:
# 1. to this workflow (github.workflow)
# 2. per event ref (github.ref)
# 3. per run on the default branch (github.run_id)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.ref_type == 'branch' && github.ref_name == github.event.repository.default_branch && github.run_id }}
  cancel-in-progress: true

jobs:
  # Build multi-platform builder and final images with caching from Docker Hub
  # and GitHub Container Registry; push to GitHub Container Registry.
  build:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v3

    - name: Set $CACHE_DATE
      run: echo "CACHE_DATE=$(date --utc +%Y%m%dT%H%M%SZ)" | tee -a "$GITHUB_ENV"

    - if: github.event_name != 'pull_request' && github.ref_type == 'branch' && github.ref_name == github.event.repository.default_branch
      name: Set $TAG (default branch)
      run: echo "TAG=build-$CACHE_DATE" | tee -a "$GITHUB_ENV"
    - if: env.TAG == ''
      name: Set $TAG (PRs, non-default branch)
      # From `man docker-image-tag`: The tag name must be valid ASCII and may
      # contain lowercase and uppercase letters, digits, underscores, periods
      # and hyphens.
      run: echo "TAG=branch-${GITHUB_REF_NAME//[^A-Za-z0-9._-]/-}" | tee -a "$GITHUB_ENV"

    - uses: docker/setup-qemu-action@v2

    # GITHUB_TOKEN is unreliable¹ so use a token from nextstrain-bot.
    # ¹ https://github.com/docker/build-push-action/issues/463#issuecomment-939394233
    - uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: nextstrain-bot
        password: ${{ secrets.GH_TOKEN_NEXTSTRAIN_BOT_MANAGE_PACKAGES }}

    - run: ./devel/build -p linux/amd64,linux/arm64 -r ghcr.io -t "$TAG"

    outputs:
      tag: ${{ env.TAG }}

  # Delete the builder and final images from GitHub Container Registry.
  cleanup-registry:
    if: always()
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: nextstrain-bot
        password: ${{ secrets.GH_TOKEN_NEXTSTRAIN_BOT_MANAGE_PACKAGES }}

    - run: ./devel/delete-images -r ghcr.io -t ${{ needs.build.outputs.tag }}
